---
title: "Vaccine Effectiveness in Catalunya"
author: "Erik and Johannes Markus Burr"
date: "16 12 2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
We'll write some introductory words later.

# Data Preparation

```{r}
library("ggplot2")
library("zoo")
```


Since this is a real data set it naturally does not come precisely in the format our analysis expects it to be. Therefore, we first have to prepare and also translate it.

```{r}
data = read.csv("Impacte_del_COVID.csv", encoding="UTF-8")
df = data
colnames(df) = c("sex", "age", "date", "event", "vaccinated", "count")

df$sex = as.factor(df$sex)               # male, female, NaN
df$age = as.factor(df$age)               # discretizied for some reason
df$event = as.factor(df$event)           # positive, hospitalized, critical (ICU)
df$date = as.Date(df$date,"%d/%m/%Y")    # now in format Year,month,day
df$vaccinated = as.factor(df$vaccinated) # none, partial, full
df$count = as.numeric(df$count)  # this means #count people with these characteristics have been observed on this day
 

# the task asks us to only analyze people older than 30
df = subset(df, age=="30 a 39" | age == "40 a 49" | age == "50 a 59" |
         age == "60 a 69" | age == "70 a 79" | age == "80 o més")

# also only between 1st March 2020 and 12. December 2021
df = subset(df, date>"2021-03-01" | date > "2021-12-12")
dim(df)
```
The dataset captures these four event types.

```{r}
table(df$event) # dependent variable
2166+         839     +     4146 
```

And shows the relationship to vaccine status.
```{r}
table(df$vaccinated)
```
# Descriptive Analysis

Firstly, let's plot the sum of all captured events as a function of time.

```{r}
ggplot( data = df, aes( date, rollmean(count,8,na.pad=TRUE), vaccinated,
                        ylab="Number of Events")) + geom_line() 
```
We have restricted the data to the time between March and December 2021, which includes the end of the Spring's wave but especially the big wave of infections in July as well as the beginning of the winter wave starting in November.

### Plots
Histograms, Bar charts, Pareto Plots.  %%%todo

### Critical Patients over time
divided by gender (and maybe also vaccination status?)

```{r}
df_critial_male = df[df$sex=="Home" & df$event=="Crítics",]

ggplot( data = df_critial_male, aes( date, rollmean(count,8,na.pad=TRUE), vaccinated )) + geom_line() 
```
```{r}
df_critial_female = df[df$sex=="Dona" & df$event=="Crítics",]

ggplot( data = df_critial_female, aes( date, rollmean(count,8,na.pad=TRUE), vaccinated )) + geom_line() 
```


```{r}
df_deaths = df[df$event=="Defunció",]
ggplot(df_deaths,aes(x=date,y=count, color=vaccinated)) + geom_line()
```


```{r}
ggplot(df_deaths,aes(x=date,y=rollmean(count,15,na.pad=TRUE), color=vaccinated)) + geom_line()
```

# Data Analysis

##  Contingency Table

A contingency table holds a count variable dependent on two (multilevel) factors. To build it we loop over the dataset, check the variables of interest and sum up the count variable and save it in a new dataframe.

### Vaccine Status and Infection Gravity
Firstly, we investige the relationship between vaccine status and the gravitiy of a coronavirus infection.

```{r}
# init dataframe for count sums
count_sums = data.frame(matrix(0,ncol=3,nrow=4))

colnames(count_sums) = c("none","partial","full")  # vaccine status
rownames(count_sums) = c("casa","hospital","critical","dead") # event type


for (i in 1:dim(df)[1]){
  content_i = df[i,]
  
  age   = content_i[2]
  vacc  = content_i[5]
  event = content_i[4]
  count = content_i[6]
  
  #  define row and col variable, where count should be increased
  if (event=="Cas") row=1
  if (event=="Hospitalització") row = 2
  if (event=="Crítics") row = 3
  if (event=="Defunció") row = 4
  
  if (vacc=="No iniciada") col =1
  if (vacc=="Parcial") col =2
  if (vacc=="Completa") col =3
  
  count_sums[row,col] = count + count_sums[row,col]
  
}
count_sums

```
%%% what'S this warning?

Now that we have the contingency table for event type by vaccine status, we can perform a $\chi^2$ test testing the independence of both factors.
This is done by calculating the Test statistic ............... %%% put in formula from slides
```{r}
chisq.test(count_sums)
```
The nullhypothesis that the type of event and vaccine status are independent can be rejected.
In order to understand where these difference are present, we calculate the expected values and subtract them from the observed.

```{r}
expected = matrix(data=0, ncol=3, nrow=4)
total = sum(count_sums)
for (i in 1:4){
  for (j in 1:3){
    expected[i,j] = (rowSums(count_sums)[[i]]*colSums(count_sums)[[j]]) / total
  }
}
count_sums - expected

```
%%% This doesn't really make, does it? The first row says that there were more cases in fully vaccinated people than expected? 

### Age and Infection Gravity
%%% this used to work
```{r}
counts = data.frame(matrix(0,ncol=5,nrow=4))

rownames(counts) = c("casa","hospital","critical","dead")

dd = df
dd$age = as.numeric(dd$age)

for (i in 1:dim(df)[1]){
  row_i = dd[i,]
  
  age   = row_i[[2]]
  vacc  = row_i[5]
  event = row_i[[4]]
  count = row_i[6]
  
  if (event=="Cas") row=1
  if (event=="Hospitalització") row = 2
  if (event=="Crítics") row = 3
  if (event=="Defunció") row = 4
  
  
  counts[row,age-3] = count + counts[row,age-3]
  # the factor starts to count at 4 for some reason
  
}

```
```{r}
chisq.test(counts)

```

#Statistical Inference
Poisson Model to fit this count variable


### Multinomial model

```{r}
#install.packages("nnet")
library(nnet)

multinom_model  = multinom(event~vaccinated,data=df)
summary(multinom_model)

```
This is kinda hard to interpret (and we didn't do it in class).
The model tries to predict the Odds of each outcome vs a baseline (here Cas) and estimates parameters to predict this proportion. 

%%% maybe we delete this and rather do the stuff from class

### Poisson Model

```{r}
poisson_model = glm(count~sex+age+vaccinated, family="poisson", data=df_deaths)
summary(poisson_model)
```
%%% the vaccine effects are weird

### Logistic Regression

To fit a simpler model, which is easier to interpret, we create a new binary variable.
We are interested in explaining which covariates are linked to a mild progression of COVID19 (defined as a 'Cas' event) and a severe sickness (anything of hospitalized, ICU or death). Our argument is, that the main interest for the general poulation are their chances of experiencing a sickness much worse than the common cold.

```{r}
# define critical case as anything worse than being positive and quarantined ("Cas")
df$severe = as.numeric(! df$event=="Cas")

# now we would need to multiply the rows by count to fit this in a regular way i think
df_enrolled = df[rep(row.names(df),df$count),]

```

```{r}
print("sanity check: ")
      dim(df_enrolled)[1] == sum(df$count) # sanity check
```
```{r}
logReg = glm(severe ~ age + vaccinated + sex, data=df_enrolled, family=binomial(link='logit'))

summary(logReg)
```
Now this is nice.


## Conclusion
