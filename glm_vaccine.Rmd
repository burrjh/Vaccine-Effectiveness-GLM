---
title: "Vaccine Effectiveness in Catalunya"
author: "Erik and Johannes Markus Burr"
date: "16 12 2021"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
We'll write some introductory words later.

# Data Preparation

```{r}
library("ggplot2")
library("zoo")
```


Since this is a real data set it naturally does not come precisely in the format our analysis expects it to be. Therefore, we first have to prepare and also translate it.

```{r}
data = read.csv("Impacte_del_COVID.csv", encoding="UTF-8")
df = data
colnames(df) = c("sex", "age", "date", "event", "vaccinated", "count")

df$sex = as.factor(df$sex)               # male, female, NaN
df$age = as.factor(df$age)               # discretizied for some reason
df$event = as.factor(df$event)           # positive, hospitalized, critical (ICU)
df$date = as.Date(df$date,"%d/%m/%Y")    # now in format Year,month,day
df$vaccinated = as.factor(df$vaccinated) # none, partial, full
df$count = as.numeric(df$count)  # this means #count people with these characteristics have been observed on this day
 

# the task asks us to only analyze people older than 30
df = subset(df, age=="30 a 39" | age == "40 a 49" | age == "50 a 59" |
         age == "60 a 69" | age == "70 a 79" | age == "80 o més")

# also only between 1st March 2020 and 12. December 2021
df = subset(df, date>"2021-03-01" | date > "2021-12-12")
dim(df)
```
The dataset captures these four event types.

```{r}
table(df$event) # dependent variable
2351+1565+5101
```

And shows the relationship to vaccine status.
```{r}
table(df$vaccinated)
```
# Descriptive Analysis

Firstly, let's plot the sum of all captured events as a function of time.

```{r}
ggplot( data = df, aes( date, rollmean(count,8,na.pad=TRUE), vaccinated,
                        ylab="Number of Events")) + geom_line() 
```
We have restricted the data to the time between March and December 2021, which includes the end of the Spring's wave but especially the big wave of infections in July as well as the beginning of the winter wave starting in November.

### Plots
Histograms, Bar charts, Pareto Plots.  %%%todo


```{r}
plot(df$age)
```
```{r}
plot(df$vaccinated,col=1:3)
```
```{r}
plot(df$sex,col=8:9)
```
```{r}
plot(df$vaccinated)
```


### Critical Patients over time
divided by gender (and maybe also vaccination status?)

```{r}
# Shall we consider "critical" as only "critics" or also hospital and deaths?
# We should do this but monthly instead of daily
df_critial_male = df[df$sex=="Home" & df$event=="Crítics",]

ggplot( data = df_critial_male, aes( date, rollmean(count,8,na.pad=TRUE), vaccinated )) + geom_line() 
```
```{r}
# Shall we consider "critical" as only "critics" or also hospital and deaths?
# We should do this but monthly instead of daily

df_critial_female = df[df$sex=="Dona" & df$event=="Crítics",]

ggplot( data = df_critial_female, aes( date, rollmean(count,8,na.pad=TRUE), vaccinated )) + geom_line() 
```


```{r}
df_deaths = df[df$event=="Defunció",]
ggplot(df_deaths,aes(x=date,y=count, color=vaccinated)) + geom_line()
```


```{r}
ggplot(df_deaths,aes(x=date,y=rollmean(count,15,na.pad=TRUE), color=vaccinated)) + geom_line()
```

# Data Analysis

##  Contingency Table

A contingency table holds a count variable dependent on two (multilevel) factors. To build it we loop over the dataset, check the variables of interest and sum up the count variable and save it in a new dataframe.

### Vaccine Status and Infection Gravity
Firstly, we investige the relationship between vaccine status and the gravitiy of a coronavirus infection.

```{r}
# init dataframe for count sums
count_sums = data.frame(matrix(0,ncol=3,nrow=4))

colnames(count_sums) = c("none","partial","full")  # vaccine status
rownames(count_sums) = c("casa","hospital","critical","dead") # event type


for (i in 1:dim(df)[1]){
  content_i = df[i,]
  
  age   = content_i[2]
  vacc  = content_i[5]
  event = content_i[4]
  count = content_i[6]
  
  #  define row and col variable, where count should be increased
  if (event=="Cas") row=1
  if (event=="Hospitalització") row = 2
  if (event=="Crítics") row = 3
  if (event=="Defunció") row = 4
  
  if (vacc=="No iniciada") col =1
  if (vacc=="Parcial") col =2
  if (vacc=="Completa") col =3
  
  count_sums[row,col] = count + count_sums[row,col]
  
}
count_sums

```

Now that we have the contingency table for event type by vaccine status, we can perform a $\chi^2$ test testing the independence of both factors.
This is done by calculating the Test statistic ............... %%% put in formula from slides
```{r}
chisq_vac = chisq.test(count_sums)
```
The nullhypothesis that the type of event and vaccine status are independent can be rejected.
In order to understand where these difference are present, we calculate the expected values and subtract them from the observed.

A nice little bar plot of different severity for different vaccination status, normalized
```{r}
count_sums_norm=count_sums
for (i in 1:3){
  count_sums_norm[,i] = count_sums[,i]/colSums(count_sums[i])
}
library(RColorBrewer)
colors4 <- brewer.pal(4,"Set1")
bar_plot4 = barplot(data.matrix(count_sums_norm), col = colors4, legend = rownames(count_sums_norm), beside = TRUE)
```

Same plot as above but binary severity, normalized
```{r}
count_sums_binary = data.frame(matrix(0,ncol=3,nrow=2))
colnames(count_sums_binary) = c("none","partial","full")  # vaccine status
rownames(count_sums_binary) = c("mild","severe") # event type

count_sums_binary[1,] = count_sums[1,]
count_sums_binary[2,] = count_sums[2,]+count_sums[3,]+count_sums[4,]
count_sums_binary_norm=count_sums_binary
for (i in 1:3){
  count_sums_binary_norm[,i] = count_sums_binary[,i]/colSums(count_sums_binary[i])
}

bar_plot2 = barplot(data.matrix(count_sums_binary_norm), col=c("red","blue"), legend = rownames(count_sums_binary), beside = TRUE)
```
Pareto charts
```{r}
library(qcc)

#For some reason I can't change "A,B,C,D" to "casa, hospital, .." :(((

pareto.chart(count_sums[,1], main = "Pareto Chart: No vaccination")
pareto.chart(count_sums[,2], main = "Pareto Chart: Partial vaccination")
pareto.chart(count_sums[,3], main = "Pareto Chart: Full vaccination")
```

```{r}
expected = matrix(data=0, ncol=3, nrow=4)
total = sum(count_sums)
for (i in 1:4){
  for (j in 1:3){
    expected[i,j] = (rowSums(count_sums)[[i]]*colSums(count_sums)[[j]]) / total
  }
}
count_sums - expected

```
Another way of writing. Gives the same answer but might be easier to understand, can skip counting on our own.
```{r}
diff_table = count_sums - chisq_vac$expected
diff_table
```

%%% This doesn't really make, does it? The first row says that there were more cases in fully vaccinated people than expected? 

%%% It makes sense. Under the null-hyp, more non-vaccinated people should have a mild reaction, and vaccinated are over-represented on mild reactions.
%%% On the other hand, surprisingly few vaccinated experience "hospital" or "critical", and the opposite for non-vaccinated.
%%% For the dying people. this is a bit weird though. It seems like vaccinated people are over-represented among the death cases.




%%% My idea was to normalize so we can see what the partial vaccination do. I don't know if it makes sense, but partial seem that partially vaccinated people experience more "casa" cases, less "hospital" and "critical", and also more "dead". Similiar too full vaccination effect but not equally strong.

%%% We should also do a table to answer: "Show the data grouped in a table form as a function of the vaccination status and the age.", for example: 
          none 30-40, none 40-50, ... , partial 30-40, ...
casa        x           x                   x
hospital    x           x                   x
critical    x           x                   x   
dead        x           x                   x
### Age and Infection Gravity
%%% this used to work
```{r}
counts = data.frame(matrix(0,ncol=6,nrow=4))

rownames(counts) = c("casa","hospital","critical","dead")

dd = df
dd$age = as.numeric(dd$age)


for (i in 1:dim(df)[1]){
  row_i = dd[i,]
  
  age   = row_i[[2]]
  vacc  = row_i[5]
  event = row_i[[4]]
  count = row_i[6]
  
  if (event=="Cas") row=1
  if (event=="Hospitalització") row = 2
  if (event=="Crítics") row = 3
  if (event=="Defunció") row = 4
  
  
  counts[row,age-3] = count + counts[row,age-3]
  # the factor starts to count at 4 for some reason
  
}

counts
```

```{r}
chisq_age = chisq.test(counts)
chisq_age
```


```{r}
counts - chisq_age$expected
```


#Statistical Inference
Poisson Model to fit this count variable

```{r}
c()
```



### Multinomial model

```{r}
#install.packages("nnet")
library(nnet)

multinom_model  = multinom(event~vaccinated,data=df)
summary(multinom_model)

```
This is kinda hard to interpret (and we didn't do it in class).
The model tries to predict the Odds of each outcome vs a baseline (here Cas) and estimates parameters to predict this proportion. 

%%% maybe we delete this and rather do the stuff from class

### Poisson Model

```{r}
poisson_model = glm(count~sex+age+vaccinated, family="poisson", data=df_deaths)
summary(poisson_model)
```
%%% the vaccine effects are weird

### Logistic Regression

To fit a simpler model, which is easier to interpret, we create a new binary variable.
We are interested in explaining which covariates are linked to a mild progression of COVID19 (defined as a 'Cas' event) and a severe sickness (anything of hospitalized, ICU or death). Our argument is, that the main interest for the general population are their chances of experiencing a sickness much worse than the common cold.

```{r}
# define critical case as anything worse than being positive and quarantined ("Cas")
df$severe = as.numeric(! df$event=="Cas")

# now we would need to multiply the rows by count to fit this in a regular way i think
df_enrolled = df[rep(row.names(df),df$count),]

```

```{r}
print("sanity check: ")
      dim(df_enrolled)[1] == sum(df$count) # sanity check
```

We want to model the probability of a person of varying age, vaccination status and sex to have a non-severe or a severe case of covid. This means we have two possible outcomes, and multiple explanatory variables. 
We are using a logistic model for this problem, because our dependent variable is binary, and we also have multiple explanatory variables which can easily be implemented in the logistic regression.
We also consider the explanatory variables as independent. For age and sex this is obviously true, but it might not be true for vaccination status and age, as well as vaccination status and sex. It is possible that older, or younger people, are more likely to be vaccinated or not (as well as men or women are more likely to be vaccinated or not).

```{r}
library(car)
logReg = glm(severe ~ age + vaccinated + sex, data=df_enrolled, family=binomial(link='logit'))
anova(logReg)
summary(logReg)

```
Now this is nice.

At a first glance we can see that all the explanatory variables are of (large) statistical significance, so we won't suppress any of them.

Let's have a look at the coefficients
```{r}
logReg$coefficients
```
We see that with increasing age we have an increasing coefficient. What does this mean?

Our model is: for $Y = 1$, which corresponds to a severe case of covid, we have probability $p = \frac{1}{1+e^{-(\beta_0 + \beta_{1}x_{1,1} + \beta_{2}x_{1,2} + \beta_{3}x_{1,3} + \beta_{4}x_{1,4} + \beta_{5}x_{1,5} + \beta_{6}x_{2,1} + \beta_{7}x_{2,2} + \beta_8x_3) } } $, where $x_{1,i} = 1$ is the categorical variable for the age interval, $x_{2,i}$ is for the vaccination status and $x_3$ is categorical variable if the person is a male. The intercept corresponds to a fully vaccinated female, 30-40 years old.

We see that increasing age leads to a higher coefficient and therefore an increasing risk of a severe covid case, as expected.
This is also seen in the vaccination status, where the risk is highest with no vaccine at all. Partially vaccination seems to lowering the risk. 
At last we can also see a positive coefficient if the person is a male, so it seems that men have a higher risk than females for a severe covid case. 
Another observation is that the coefficient for persons with age $>80$ is (way) larger than the coefficient for unvaccinated persons, which implies that the most dominant explanatory variable is the age rather than vaccination status. 

```{r}
poi_mod <-glm(formula = severe ~ age+vaccinated+sex, data = df_enrolled,
   family = poisson)
summary(poi_mod)

```

```{r}
library(car)
library(RcmdrMisc)

residualPlot(logReg)
```



%%% TODO
----------------------------------
% exploratory plots ->
% fit a poisson -> ME
% different links for logistic (compare with AIC) 
% residual plots       -> ME/erik
% do model prediction  -> ME



## Conclusion
