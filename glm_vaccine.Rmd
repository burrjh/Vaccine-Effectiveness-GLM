---
title: "Vaccine Effectiveness in Catalunya"
author: "Erik and Johannes Markus Burr"
date: "16 12 2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction
We'll write some introductory words later.

## Data Preparation

Since this is a real data set it naturally does not come precisely in the form our analysis expects it to be. Therefore, we first have to prepare and also translate it.

```{r}
data = read.csv("Impacte_del_COVID.csv", encoding="UTF-8")
df = data
colnames(df) = c("sex", "age", "date", "event", "vaccinated", "count")

df$sex = as.factor(df$sex)               # male, female, NaN
df$age = as.factor(df$age)               # discretizied for some reason
df$event = as.factor(df$event)           # positive, hospitalized, critical (ICU)
df$date = as.Date(df$date,"%d/%m/%Y")    # now in format Year,month,day
df$vaccinated = as.factor(df$vaccinated) # none, partial, full
df$count = as.numeric(df$count)  # this means #count people with these characteristics have been observed on this day

# the task asks us to only analyze people older than 30
df = subset(df, age=="30 a 39" | age == "40 a 49" | age == "50 a 59" |
         age == "60 a 69" | age == "70 a 79" | age == "80 o més")

# also only between 1st March 2020 and 12. December 2021
df = subset(df, date>"2021-03-01" | date > "2021-12-12")
dim(df)
```
I have pasted the task from the pdf below. We should at least do that.

```{r}
table(df$event) # dependent variable
2166+         839     +     4146 
```
```{r}
table(df$vaccinated)
```
```{r}
with(df,table(count~age,vaccinated))
```

```{r}
glm(count~sex+vaccinated+event, family="poisson", data=df)
```


## vaccine :          #full #partial #none
# sickness #casa
          #hospital
          #critical
          #dead

```{r}
count_sums = data.frame(matrix(0,ncol=3,nrow=4))

colnames(count_sums) = c("none","partial","full")  # vaccine status
rownames(count_sums) = c("casa","hospital","critical","dead")


for (i in 1:dim(df)[1]){
  stuff = df[i,]
  
  age = stuff[2]
  vacc = stuff[5]
  event = stuff[4]
  count = stuff[6]
  
  if (event=="Cas") row=1
  if (event=="Hospitalització") row = 2
  if (event=="Crítics") row = 3
  if (event=="Defunció") row = 4
  
  if (vacc=="No iniciada") col =1
  if (vacc=="Parcial") col =2
  if (vacc=="Completa") col =3
  
  count_sums[row,col] = count + count_sums[row,col]
  
}


count_sums

```

```{r}
chisq.test(count_sums)
```
```{r}
expected = matrix(data=rep(1,4*3), ncol=3, nrow=4)
total = sum(count_sums)
for (i in 1:4){
  for (j in 1:3){
    expected[i,j] = (rowSums(count_sums)[i]*colSums(count_sums)[j]) / total
  }
}
expected

```
```{r}
count_sums - expected
```
This descriptively shows where the differences between observed-expected lie. I am not quite sure if this makes sense, at least in the first row.

```{r}

counts = data.frame(matrix(0,ncol=5,nrow=4))

rownames(counts) = c("casa","hospital","critical","dead")

dd = df
dd$age = as.numeric(dd$age)

for (i in 1:dim(df)[1]){
  stuff = dd[i,]
  
  age = stuff[[2]]
  vacc = stuff[5]
  event = stuff[4]
  count = stuff[6]
  
  if (event=="Cas") row=1
  if (event=="Hospitalització") row = 2
  if (event=="Crítics") row = 3
  if (event=="Defunció") row = 4
  
  
  counts[row,age-3] = count + counts[row,age-3]
  # the factor starts to count at 4 for some reason
  
}

```
```{r}
chisq.test(counts)

```



## Descriptive Analysis
### Plots
Histograms, Bar charts, Pareto Plots.

### Critical Patients over time
divided by gender (and maybe also vaccination status?)

```{r}
library(ggplot2)

df_critial_male = df[df$sex=="Home" & df$event=="Crítics",]

ggplot( data = df_critial_male, aes( date, count, vaccinated )) + geom_line() 
```
```{r}
df_critial_female = df[df$sex=="Dona" & df$event=="Crítics",]

ggplot( data = df_critial_female, aes( date, count, vaccinated )) + geom_line() 
```



```{r}
dd = df[df$event=='Hospitalització',]
dd = dd[dd$date<"2021-09-30" & dd$date > "2021-07-01",]

with(dd[df$vaccinated=="Completa",],plot(x=date,y=count,type='l', col='green'))
par(new=T)
with(dd[df$vaccinated=="No iniciada",],plot(x=date,y=count,type='l', col='red'))
```
```{r}

ggplot( data = dd[dd$vaccinated=="Completa",], aes( date, count )) + geom_line()
```
```{r}

ggplot( data = dd[dd$vaccinated=="No iniciada",], aes( date, count )) + geom_line()
```


### Contingency Table
Count as function of vaccination status and age

## Statistical Inference
Poisson Model to fit this count variable


#### Multinomial model

```{r}
#install.packages("nnet")
library(nnet)

multi_vacc = multinom(event~vaccinated,data=df)
summary(multi_vacc)

```

##### binary "good case" vs "critical case"

```{r}
# define critical case as anything worse than being positive and quarantined ("Cas")
df$critial = as.numeric(! df$event=="Cas")

# now we would need to multiply the rows by count to fit this in a regular way i think
```


## Conclusion
